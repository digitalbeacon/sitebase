function initPermissionEditPanel(a){var d=$("#permissionItemListPanel").data("sbListPanel");d.permissions=a.permissions;var c=$("#permissionError");d.valid=true;d.getPermission=function(h,f,g){for(var e=0;e<d.permissions.length;e++){if(d.permissions[e].entityType==h&&d.permissions[e].entityId==f){if(g){return d.permissions.splice(e,1)[0]}return d.permissions[e]}}return null};d.addPermission=function(g,e,f){d.permissions.push({entityType:g,entityId:e,mask:f});d.valid=true;c.hide()};d.newTemplate=$("#newTemplate").removeAttr("id").remove();d.editorTemplate=$("#editorTemplate").remove();d.initEditor=function(g,e,f){d.valid=false;d.editorTemplate.unbind("click.sbListPanel");d.editorTemplate.click(function(h){h.stopPropagation()});d.editorTemplate.find("td.accept a").click(function(){var h=$("#EntityType");var k=h.val();var j=$("#EntityId").val();if(!k||k<=0||!j||j<0){c.text(a.errorRequired).show();return}if(d.getPermission(k,j)){c.text(a.errorDuplicate).show();return}var l=0;if($("#Access").is(":checked")){l=l|a.access}if($("#Create").is(":checked")){l=l|a.create}if($("#Update").is(":checked")){l=l|a.update}if($("#Delete").is(":checked")){l=l|a.del}if($("#Admin").is(":checked")){l=l|a.admin}d.addPermission(k,j,l);var m=d.editorTemplate.prev();var i=m.find("td.data span");i.attr("data-type",k);i.attr("data-id",j);m.find("td.type").text(h.find("option:selected").text());if(k==a.roleId){m.find("td.name").text($("#Role").find("option:selected").text())}else{if(k==a.roleGroupId){m.find("td.name").text($("#RoleGroup").find("option:selected").text())}else{m.find("td.name").text(j)}}m.find("td.config.access input").attr("checked",(l&a.access)>0);m.find("td.config.create input").attr("checked",(l&a.create)>0);m.find("td.config.update input").attr("checked",(l&a.update)>0);m.find("td.config.del input").attr("checked",(l&a.del)>0);m.find("td.config.admin input").attr("checked",(l&a.admin)>0);d.editorTemplate.remove();m.show();d.resetAlternatingRows();return false});d.editorTemplate.find("td.cancel a").click(function(){d.editorTemplate.remove();if(d.current){d.addPermission(d.current.entityType,d.current.entityId,d.current.mask);d.current=null;$("tbody tr:hidden",d.element).show()}else{$("tbody tr:first",d.element).remove()}d.valid=true;c.hide();d.resetAlternatingRows();return false});d.editorTemplate.find("#EntityType").change(function(){var h=$("#EntityId");var i=$("#Role").hide();var j=$("#RoleGroup").hide();if(this.value==a.roleId){i.show().val(h.val())}else{if(this.value==a.roleGroupId){j.show().val(h.val())}}});d.editorTemplate.find("#Role, #RoleGroup").change(function(){$("#EntityId").val(this.value)});$("#EntityId").val(e);$("#EntityType").val(g).change();$("#Access").attr("checked",(f&a.access)>0);$("#Create").attr("checked",(f&a.create)>0);$("#Update").attr("checked",(f&a.update)>0);$("#Delete").attr("checked",(f&a.del)>0);$("#Admin").attr("checked",(f&a.admin)>0)};d.addItem=function(){$("#accept").click();if(d.valid){$("tbody",this.element).prepend(d.newTemplate.clone());d.selectItem($("tbody tr:first",this.element)[0])}};d.removeItem=function(f){var g=$(f).closest("tr");if(g.attr("id")=="editorTemplate"){g=g.prev();d.editorTemplate.remove()}var e=g.find("td.data span");d.getPermission(e.attr("data-type"),e.attr("data-id"),true);g.remove();this.resetAlternatingRows()};d.selectItem=function(g){var e=$(g);if(this.id!="editorTemplate"){$("#accept").click();if(!d.valid){return}e.hide();e.after(d.editorTemplate);this.gridDataBound();this.resetAlternatingRows();var f=e.find("td.data span");d.current=d.getPermission(f.attr("data-type"),f.attr("data-id"),true);d.initEditor(f.attr("data-type"),f.attr("data-id"),d.current?d.current.mask:0)}};var b=$("#permissionEditPanel").data("sbFormPanel");b.submitForm=function(f){var g=this;if($.sb.checkFormSubmission(f)){var e=$(f).serializeArray();$.each(d.permissions,function(h,j){e[e.length]={name:"Permissions["+h+"].EntityType",value:j.entityType};e[e.length]={name:"Permissions["+h+"].EntityId",value:j.entityId};e[e.length]={name:"Permissions["+h+"].Mask",value:j.mask}});$.post(f.action,$.param(e),function(h){if(g.ajax){g.updateContent(h,"submit")}else{$("#contentPanel").html(h);$.sb.displayMessageSummaryAsModalBox()}})}return false};$("#save",b.element).click(function(){$("#accept").click();if(!d.valid){return false}})};