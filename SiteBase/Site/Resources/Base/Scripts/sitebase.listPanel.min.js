(function(a){a.sb.listPanel=function(d,f){this.element=d;this.deleteConfirmText=a.sb.localization.confirmText;this.isRefreshing=false;a.extend(this,f);var e=this;var c=a(this.gridId,this.element);if(e.newActionUrl){if(e.newTooltip){c.find("th."+this.newClass).attr("title",e.newTooltip)}a("."+this.newClass,this.element).click(function(){e.addItem();return false})}this.search=a(this.searchId,this.element);if(this.search.length){this.searchText=a(this.searchTextId,this.element);this.clearSearch=a(this.clearSearchId,this.element);if(!this.searchText.val()||this.searchText.val()==this.defaultSearchText){this.clearSearch.hide()}this.searchText.focus(function(){if(this.value==e.defaultSearchText){a(this).removeClass("empty");this.value=""}});this.searchText.blur(function(){if(!this.value||this.value==e.defaultSearchText){a(this).addClass("empty");this.value=e.defaultSearchText}});this.searchText.blur();this.clearSearch.click(function(){e.searchText.val("");e.searchText.blur();e.search.click();e.clearSearch.hide();return false});this.search.click(function(){var g=e.searchText.val().trim();if(g==e.defaultSearchText){g=""}if(e.alwaysApplySearch||g||e.clearSearch.is(":visible")||this.form.elements.length>1){e.applySearch()}if(g){e.clearSearch.show()}else{e.clearSearch.hide()}return false});this.searchText.keypress(function(g){if(g.keyCode=="13"){e.search.click();return false}})}a(this.element).bind("refresh",function(g){if(e.isRefreshing){return}e.isRefreshing=true;a.sb.log(e.element.id+" refreshing...");e.gridRefresh()});this.gridPostInit()};a.sb.listPanel.prototype={gridPostInit:function(){var g=this;var c=a(this.gridId,this.element);this.grid=c.data("tGrid");if(!this.grid){var d=(c.data("initAttempts")||0)+1;if(d>=10){a.sb.log("tGrid not initialized for "+this.element.id)}else{c.data("initAttempts",d);setTimeout(function(){g.gridPostInit()},250);return}}if(this.grid.ajax){this.gridAjaxUrl=this.grid.ajax.selectUrl}if(this.itemSequencerKey){var e=c.find("th:not(.t-hierarchy-cell)");for(var f=0;f<e.length;f++){if(a(e[f]).hasClass(this.selectClass)){this.itemSequencer=new a.sb.itemSequencer(this,a(this.grid.columns[f].format.replace("{0}",0)).attr("href").replace("0","{0}"));a.sb.itemSequencers[this.itemSequencerKey]=this.itemSequencer;break}}}if(a.sb.localization.culture!="en-US"){this.grid.updatePager()}if(!this.grid.onDataBound){this.grid.onDataBound=function(){g.gridDataBound()};c.bind("dataBound",this.grid.onDataBound);this.gridDataBound()}},gridDataBound:function(){var g=this;var c=a(this.gridId,this.element);if(this.enableSelect){var d=c.find("."+this.selectClass);if(this.itemSequencer){var f=0;c.find("."+this.selectClass+" a").click(function(i){i.preventDefault()}).each(function(){g.itemSequencer.addItem(g.grid.currentPage,f++,a(this).attr("data-id"))});this.itemSequencer.pages.push(this.grid.currentPage);if(this.itemSequencer.queuedAction){var h=this.itemSequencer.getCurrent();if(h){a.sb.log("executing queued action for: "+h);this.itemSequencer.queuedAction(h)}else{a.sb.log("could not find previous or next item in sequencer")}this.itemSequencer.queuedAction=null}}c.find("tbody tr").unbind("click.sbListPanel").bind("click.sbListPanel",function(j){var k=c.data("last-selection");if(k&&new Date().getTime()-k<500){return false}else{if(!(a(j.target).hasClass("t-icon"))){c.data("last-selection",new Date().getTime());if(g.selectItem){g.selectItem(this)}else{g.defaultSelectItem(this)}if(!g.maintainSelection){return false}}else{if(!g.maintainSelection){var i=a(this);setTimeout(function(){i.removeClass("t-state-selected")},0)}}}})}if(this.enableDelete){var e=c.find("tbody ."+this.deleteClass+" a");if(g.deleteTooltip){e.attr("title",g.deleteTooltip)}e.unbind("click.sbListPanel").bind("click.sbListPanel",function(){g.gridRowDelete(this);return false})}if((this.grid.total==undefined&&this.grid.$rows().length)||this.grid.total||a(this.clearSearchId+":visible",this.element).length){if(this.enableNoItemsMessage){c.show();a(".no-items",this.element).hide()}if(this.hideSearchPanelWhenEmpty){a("."+this.searchPanelClass,this.element).show()}}else{if(this.enableNoItemsMessage){c.hide();a(".no-items",this.element).show()}if(this.hideSearchPanelWhenEmpty){a("."+this.searchPanelClass,this.element).hide()}}if(this.grid.total){a(".t-pager",this.grid.element).show()}else{a(".t-pager",this.grid.element).hide();if(this.noMatchesText){a(".t-status-text",this.grid.element).text(this.noMatchesText)}}a(this.element).trigger("dataBound");if(this.itemSequencer&&this.itemSequencer.initiatedPaging){this.itemSequencer.initiatedPaging=false}else{a(window).resize()}this.isRefreshing=false},gridRowDelete:function(c){if(confirm(this.deleteConfirmText)){this.removeItem(c)}},gridRefresh:function(){this.grid.ajaxRequest();if(this.itemSequencer){this.itemSequencer.reset()}},getAugmentedUrl:function(c){if(this.augmentParams){return a.digitalbeacon.mergeParams(c,this.augmentParams)}return c},applySearch:function(){this.grid.currentPage=1;if(this.search.length){var e=this.search[0].form;var d={};for(var c=0;c<e.elements.length;c++){if(e.elements[c].name==this.searchText.attr("name")&&e.elements[c].value==this.defaultSearchText){d[e.elements[c].name]=""}else{d[e.elements[c].name]=e.elements[c].value}}this.grid.ajax.selectUrl=a.digitalbeacon.mergeParams(this.gridAjaxUrl,d)}else{this.grid.ajax.selectUrl=this.gridAjaxUrl}this.gridRefresh()},defaultSelectItem:function(d){var c=a("."+this.selectClass+" a",d);if(c.length){if(this.itemSequencer){this.itemSequencer.setCurrent(c.attr("data-id"))}a.sb.modalBox({ajax:this.getAugmentedUrl(c.attr("href")),replace:false,width:this.modalBoxWidth,anchorTop:this.anchorSelectModal})}},addItem:function(){if(this.itemSequencer){this.itemSequencer.currentIndex=-1}a.sb.modalBox({ajax:this.getAugmentedUrl(this.newActionUrl),replace:false,width:this.modalBoxWidth})},removeItem:function(c){var d=this;a.ajax({url:c.href,type:"DELETE",success:function(e){if(d.grid.$rows().length==1&&d.grid.currentPage>1){d.grid.pageTo(d.grid.currentPage-1)}else{d.gridRefresh()}a.sb.modalBox({content:e,replace:false})}})},resetAlternatingRows:function(){var d=this.grid.$rows();for(var c=0;c<d.length;c++){if(c%2==1){a(d[c]).addClass("t-alt")}else{a(d[c]).removeClass("t-alt")}}}};a.fn.sbListPanel=function(c){c=a.extend({},a.fn.sbListPanel.defaults,c);return this.each(function(){if(!a(this).data("sbListPanel")){var d=new a.sb.listPanel(this,c);a(this).data("sbListPanel",d)}})};a.fn.sbListPanel.defaults={gridId:"#grid",enableSelect:true,maintainSelection:false,selectClass:"select",newId:"#new",newClass:"new",enableDelete:true,deleteClass:"delete",searchPanelClass:"search-panel",searchId:"#search",searchTextId:"#searchText",clearSearchId:"#clearSearch",alwaysApplySearch:false,hideSearchPanelWhenEmpty:false,itemSequencerKey:null,customGridRowSelect:null,enableNoItemsMessage:true,defaultSearchText:"",augmentParams:null,modalBoxWidth:null,anchorSelectModal:false};a.sb.itemSequencer=function(c,d){this.keys={};this.pages=[];this.currentIndex=-1;this.listPanel=c;this.urlFormat=d};a.sb.itemSequencer.prototype={reset:function(){this.keys={};this.pages=[];this.currentIndex=-1},getUrl:function(c){return this.listPanel.getAugmentedUrl(this.urlFormat.replace("{0}",c))},addItem:function(d,c,e){this.keys[(d-1)*this.listPanel.grid.pageSize+c]=e},setCurrent:function(c){this.currentIndex=this._getIndex(c)},getCurrent:function(){if(!this.currentIndex>=0){return this.getUrl(this.keys[this.currentIndex])}return null},isFirst:function(){return this.currentIndex==0},isLast:function(){return this.currentIndex==this.listPanel.grid.total-1},getNext:function(c){if(!this.isLast()){this.currentIndex++;if(this.keys[this.currentIndex]){c(this.getUrl(this.keys[this.currentIndex]))}else{this.queuedAction=c}this._getPage(this._getCurrentPage())}},getPrevious:function(c){if(!this.isFirst()){this.currentIndex--;if(this.keys[this.currentIndex]){c(this.getUrl(this.keys[this.currentIndex]))}else{this.queuedAction=c}this._getPage(this._getCurrentPage())}},_getPage:function(c){if(c<1||c>this.listPanel.grid.totalPages(this.listPanel.grid.total)){return}if(this.listPanel.grid.currentPage!=c){this.initiatedPaging=true;this.listPanel.grid.pageTo(c)}},_getIndex:function(c){for(var d in this.keys){if(this.keys[d]==c){return d}}return -1},_getCurrentPage:function(){return Math.ceil((this.currentIndex+1)/this.listPanel.grid.pageSize)}};a.sb.itemSequencers={};if(a.fn.tGrid){var b=a.fn.tGrid.defaults;a.fn.tGrid=function(d){var c=a.telerik;return c.create(this,{name:"tGrid",init:function(e,f){return new c.grid(e,f)},options:d,success:function(e){}})};a.fn.tGrid.defaults=b}})(jQuery);